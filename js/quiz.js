const quizBank = [
  {
    q: "Почему в тумане звук иногда кажется ближе, чем на самом деле?",
    a: ["Туман усиливает громкость", "Звук отражается от капель и рассеивается иначе", "Туман ускоряет звук", "Ухо в тумане хуже различает частоты"],
    correct: 1,
    explain: "Туман — это множество микрокапель воды. Они рассеивают высокие частоты сильнее, и звук теряет «чёткость направления». Мозг хуже определяет, откуда он идёт, поэтому кажется, что источник ближе или «вокруг тебя».",
    tag: "звук/погода"
  },
  {
    q: "Почему в горах эхо слышно лучше?",
    a: ["Потому что воздух разреженный", "Потому что меньше птиц", "Потому что есть отражающие поверхности (скалы)", "Потому что звук там громче"],
    correct: 2,
    explain: "Эхо появляется, когда звук отражается и возвращается с задержкой. Скалистые поверхности работают как зеркала для звуковых волн. Чем дальше и «жёстче» преграда, тем отчётливее отражение.",
    tag: "звук"
  },
  {
    q: "Что быстрее распространяется в воздухе: звук или свет?",
    a: ["Звук", "Свет", "Они одинаковые", "Зависит от погоды"],
    correct: 1,
    explain: "Свет распространяется примерно со скоростью 300 000 км/с, а звук в воздухе — около 343 м/с (при комнатной температуре). Именно поэтому молнию видно почти сразу, а гром приходит позже.",
    tag: "скорости"
  },
  {
    q: "Почему горячий воздух поднимается вверх?",
    a: ["Его подталкивает ветер", "Он становится менее плотным (легче) при нагреве", "Его притягивает солнце", "Потому что он всегда влажный"],
    correct: 1,
    explain: "При нагреве молекулы воздуха двигаются быстрее и в среднем дальше друг от друга. Воздух расширяется, его плотность уменьшается, и более холодный плотный воздух «выталкивает» тёплый вверх.",
    tag: "термодинамика"
  },
  {
    q: "Почему зимой стекло запотевает изнутри, когда на улице холодно?",
    a: ["Стекло пропускает дым", "Влага из воздуха конденсируется на холодной поверхности", "Это из-за пыли", "Воздух становится тяжелее"],
    correct: 1,
    explain: "Тёплый воздух внутри комнаты содержит водяной пар. Когда он касается холодного стекла, воздух у поверхности резко охлаждается и уже не может удерживать столько влаги — пар превращается в капли воды (конденсация).",
    tag: "влага/тепло"
  },
  {
    q: "Почему узоры инея на стекле выглядят как «веточки»?",
    a: ["Их рисует ветер", "Лёд кристаллизуется в характерные формы", "Это царапины", "Это от соли"],
    correct: 1,
    explain: "Иней — это кристаллы льда, которые растут по законам кристаллизации. Им удобно «ветвиться», потому что так кристалл быстрее собирает влагу с поверхности и воздуха. Поэтому появляются похожие на растения структуры.",
    tag: "кристаллы"
  },
  {
    q: "Почему корабль из металла не тонет?",
    a: ["Металл легче воды", "Потому что внутри воздух", "Потому что корабль вытесняет достаточный объём воды", "Потому что вода солёная"],
    correct: 2,
    explain: "Важно не «материал», а средняя плотность всего объекта. Корпус корабля так устроен, что он вытесняет большой объём воды, а значит получает большую выталкивающую силу. Если выталкивающая сила равна или больше веса — корабль держится на воде.",
    tag: "плавучесть"
  },
  {
    q: "Что тяжелее: 1 кг ваты или 1 кг железа?",
    a: ["Вата", "Железо", "Одинаково", "Зависит от влажности"],
    correct: 2,
    explain: "Подвох в ощущениях: вата объёмнее, кажется «легче». Но масса одинаковая — 1 килограмм. Разница только в плотности и объёме.",
    tag: "логика"
  },
  {
    q: "Почему иногда в тишине слышно, как «шумит» ухо?",
    a: ["Это кровь и работа нервной системы", "Это ультразвук из воздуха", "Это звук костей", "Это резонанс комнаты"],
    correct: 0,
    explain: "В абсолютной тишине мозг замечает внутренние шумы: кровоток, нервную активность, работу мышц. Обычно внешние звуки всё это «маскируют», но в тишине фон становится заметным.",
    tag: "физиология/звук"
  },
  {
    q: "Почему гром «рычит», а не звучит одним щелчком?",
    a: ["Звук ломается об облака", "Молния имеет длину и звук приходит с разных точек", "Гром всегда отражается от земли", "Это из-за ветра"],
    correct: 1,
    explain: "Молния — не точка, а длинный канал. Звук от разных участков молнии приходит с разной задержкой. Плюс отражения от земли и зданий добавляют «слои», поэтому гром тянется и «ворчит».",
    tag: "звук/атмосфера"
  },
  {
    q: "Почему зимой легче услышать далёкие звуки?",
    a: ["Зимой тише", "Холодный воздух плотнее и иногда лучше проводит звук у земли", "Снег отражает звук", "Потому что люди говорят громче"],
    correct: 1,
    explain: "На звук влияет слоистость воздуха по температуре. В холодную погоду может возникать температурная инверсия: звук «загибается» вниз и распространяется дальше вдоль земли. Поэтому далёкие звуки кажутся ближе.",
    tag: "звук/погода"
  },
  {
    q: "Что происходит с давлением воды, если нырнуть глубже?",
    a: ["Оно уменьшается", "Оно не меняется", "Оно увеличивается", "Зависит от солёности"],
    correct: 2,
    explain: "Чем глубже — тем больше столб воды сверху давит на тебя. Давление растёт примерно на 1 атмосферу каждые 10 метров глубины. Поэтому уши закладывает при погружении.",
    tag: "давление"
  },
  {
    q: "Почему в горах вода закипает при более низкой температуре?",
    a: ["Потому что холоднее", "Потому что меньше давление воздуха", "Потому что вода другая", "Потому что больше соли"],
    correct: 1,
    explain: "Кипение начинается, когда давление пара воды сравнивается с внешним давлением. В горах атмосферное давление ниже — значит, нужное условие достигается при меньшей температуре. Поэтому вода кипит, например, при 90–95°C.",
    tag: "физика/тепло"
  },
  {
    q: "Почему мокрая одежда на ветру сохнет быстрее?",
    a: ["Ветер нагревает", "Ветер уносит влажный воздух и ускоряет испарение", "Ветер «выдувает» воду", "Так кажется"],
    correct: 1,
    explain: "Испарение тормозится, если вокруг ткани воздух уже насыщен влагой. Ветер постоянно заменяет этот влажный слой на более сухой воздух. Поэтому молекулы воды легче уходят с поверхности — и всё сохнет быстрее.",
    tag: "испарение"
  },
  {
    q: "Почему в закрытой комнате без движения воздуха становится душно?",
    a: ["Кислород исчезает мгновенно", "Растёт CO₂ и влажность, ухудшая самочувствие", "Воздух становится тяжелее", "Уши привыкают к тишине"],
    correct: 1,
    explain: "Мы выдыхаем CO₂ и водяной пар. В закрытом помещении их концентрация растёт, а кислород постепенно уменьшается. Даже небольшое повышение CO₂ может ощущаться как «душно» и вызывать усталость.",
    tag: "воздух"
  },
  {
    q: "Почему на морозе металл кажется холоднее дерева?",
    a: ["Металл всегда холоднее", "Металл лучше проводит тепло и быстрее отнимает его у руки", "Дерево греет", "Металл влажный"],
    correct: 1,
    explain: "Оба предмета могут быть одной температуры, но металл обладает высокой теплопроводностью. Он быстро забирает тепло от кожи, и рецепторы воспринимают это как сильный холод. Дерево проводит тепло хуже — рука не так быстро остывает.",
    tag: "теплопроводность"
  },
  {
    q: "Почему в пустой бутылке слышно «дуновение», если дуть в горлышко?",
    a: ["Потому что внутри эхо", "Потому что воздух внутри резонирует", "Потому что пластик свистит", "Потому что так устроено горлышко"],
    correct: 1,
    explain: "Бутылка работает как резонатор: воздух внутри колеблется на определённой частоте. Дутьё возбуждает эти колебания, и мы слышим устойчивый тон. Частота зависит от объёма бутылки и размера горлышка.",
    tag: "резонанс"
  },
  {
    q: "Почему иногда небо кажется ближе перед грозой?",
    a: ["Оно реально опускается", "Это эффект освещения и контраста облаков", "Звук тянет облака вниз", "Из-за давления земля «поднимается»"],
    correct: 1,
    explain: "Перед грозой облака становятся плотными, тёмными, контраст усиливается, свет рассеянный. Мозг читает это как «потолок ниже», хотя физически расстояние не меняется. Это визуальная иллюзия восприятия глубины.",
    tag: "оптика/погода"
  },
  {
    q: "Почему в очень влажном воздухе становится «тяжелее дышать»?",
    a: ["Кислорода меньше", "Испарение пота хуже, тело хуже охлаждается", "Влага ядовитая", "Лёгкие тяжелее"],
    correct: 1,
    explain: "Проблема не в кислороде, а в охлаждении. Когда влажность высокая, пот испаряется хуже, тепло отводится слабее, и организм перегревается. Отсюда ощущение духоты и «тяжёлого воздуха».",
    tag: "влага/тело"
  },
  {
    q: "Почему звук в воде распространяется быстрее, чем в воздухе?",
    a: ["Потому что вода холоднее", "Потому что вода плотнее и упругие связи передают колебания быстрее", "Потому что рыбы помогают", "Это миф"],
    correct: 1,
    explain: "Звук — это колебания. В воде молекулы расположены ближе и сильнее связаны упругими силами, поэтому колебания передаются быстрее. В воде скорость звука примерно 1500 м/с, в воздухе — около 343 м/с.",
    tag: "звук/среды"
  },
  {
    q: "Что из этого НЕ является теплопередачей?",
    a: ["Теплопроводность", "Конвекция", "Излучение", "Отражение"],
    correct: 3,
    explain: "Тепло передаётся тремя способами: теплопроводностью (через контакт), конвекцией (переносом вещества) и излучением (электромагнитными волнами). Отражение относится к свету/волнам, но само по себе не является механизмом переноса тепла.",
    tag: "тепло"
  },
  {
    q: "Почему стеклянная банка может лопнуть, если налить в неё кипяток?",
    a: ["Стекло боится воды", "Резкий температурный перепад создаёт напряжения в стекле", "Кипяток растворяет стекло", "Вода расширяется и давит"],
    correct: 1,
    explain: "Внутренняя поверхность банки нагревается быстрее, чем внешняя. Возникает разница температур, и стекло расширяется неравномерно. Это создаёт напряжения, которые могут привести к трещине или разлому.",
    tag: "материалы"
  },
  {
    q: "Почему свисток свистит?",
    a: ["Воздух трётся об стенки", "Возникают устойчивые колебания воздуха (резонанс) в камере", "Пластик вибрирует", "Это магия формы"],
    correct: 1,
    explain: "Свисток создаёт вихри воздуха, которые возбуждают резонанс внутри полости. Когда частота возмущений совпадает с собственной частотой камеры, звук становится сильным и устойчивым. Поэтому разные свистки имеют разный тон.",
    tag: "резонанс"
  },
  {
    q: "Почему в мороз сухой снег «скрипит» под ногами сильнее?",
    a: ["Он более грязный", "Кристаллы льда ломаются и трутся друг о друга", "Снег содержит соль", "Потому что холод усиливает звук"],
    correct: 1,
    explain: "При сильном морозе снег сухой и состоит из твёрдых кристалликов. Они ломаются и трутся, создавая характерный скрип. В более тёплую погоду снег влажный и звук становится мягче.",
    tag: "кристаллы/звук"
  },
  {
    q: "Почему «тишина» в лесу может быть громче, чем в городе ночью?",
    a: ["Потому что лес шумит", "Потому что мозг начинает замечать тихие детали (листья, насекомые)", "Потому что город полностью молчит", "Потому что в лесу эхо"],
    correct: 1,
    explain: "Когда исчезает привычный городской шум, мозг перестаёт его «фильтровать». Тогда слышны мелочи: листья, ветки, насекомые, дальние звуки. Это не значит, что лес громче — просто порог внимания смещается.",
    tag: "восприятие"
  },
  {
    q: "Почему иногда кажется, что предметы в тумане дальше, чем они есть?",
    a: ["Туман увеличивает расстояние", "Контраст падает, и мозг хуже оценивает глубину", "Зрение становится сверхчётким", "Капли искажают время"],
    correct: 1,
    explain: "Глубину мы оцениваем по контрасту, резкости и деталям. В тумане всё «съедается» и становится бледнее, поэтому мозг может ошибочно воспринимать объект как более далёкий. Это стандартная оптическая ловушка.",
    tag: "оптика"
  },
  {
    q: "Какая сила удерживает планеты на орбитах?",
    a: ["Сила трения", "Сила тяжести (гравитация)", "Электрическая сила", "Сила давления"],
    correct: 1,
    explain: "Планета стремится лететь по прямой, но гравитация постоянно «подгибает» её траекторию к центру. Так получается орбита — непрерывное падение вокруг объекта. Без гравитации планеты улетели бы по касательной.",
    tag: "космос"
  },
  {
    q: "Почему при хлопке ладонями в комнате слышно короткое эхо, а на улице — почти нет?",
    a: ["На улице звук исчезает", "В комнате больше отражающих поверхностей", "На улице больше ветра", "Потому что на улице другой воздух"],
    correct: 1,
    explain: "Эхо зависит от отражений. В комнате стены, потолок и мебель возвращают звук обратно, создавая задержки. На открытом пространстве отражающих поверхностей меньше — звук рассеивается и быстро затухает.",
    tag: "звук"
  },
  {
    q: "Почему лампа накаливания горячая, а светодиод — обычно нет?",
    a: ["Светодиод не потребляет энергию", "Лампа накаливания большую часть энергии превращает в тепло", "Светодиод охлаждается воздухом", "Потому что стекло горячее"],
    correct: 1,
    explain: "Лампа накаливания светит за счёт раскалённой нити — это по сути нагрев до высокой температуры. Светодиод производит свет эффективнее, меньше энергии уходит в тепло. Поэтому при той же яркости он обычно холоднее (хотя мощные LED тоже греются).",
    tag: "энергия"
  },
  {
    q: "Почему при открытии бутылки газировки появляются пузырьки?",
    a: ["Газ рождается из воды", "Давление падает, и растворённый CO₂ выходит", "Вода начинает кипеть", "Пузырьки — это воздух"],
    correct: 1,
    explain: "Под давлением CO₂ хорошо растворяется в жидкости. Когда ты открываешь бутылку, давление над напитком падает, и газу становится «невыгодно» оставаться растворённым. Он выходит в виде пузырьков, особенно на неровностях.",
    tag: "давление/газы"
  },
  {
    q: "Почему звук может усиливаться в узком коридоре?",
    a: ["Потому что звук любит тесноту", "Потому что отражения складываются и дают эффект усиления", "Потому что воздух там быстрее", "Потому что стены шумят"],
    correct: 1,
    explain: "В коридоре звук многократно отражается от стен. Если отражения приходят достаточно близко по времени, они могут восприниматься как более громкий звук. Иногда появляется стоячая волна или резонанс — и некоторые частоты усиливаются особенно заметно.",
    tag: "резонанс/звук"
  },
  {
    q: "Почему лёд плавает в воде?",
    a: ["Потому что он холодный", "Потому что у льда меньше плотность, чем у воды", "Потому что вода выталкивает всё", "Потому что лёд содержит воздух"],
    correct: 1,
    explain: "При замерзании вода образует кристаллическую решётку, которая занимает больше объёма. Масса та же, объём больше → плотность меньше. Поэтому лёд легче воды на единицу объёма и плавает.",
    tag: "плотность"
  },
  {
    q: "Почему стеклянная линза может фокусировать свет?",
    a: ["Потому что стекло блестит", "Потому что свет меняет скорость в стекле и преломляется", "Потому что линза тёплая", "Потому что свет отражается внутри"],
    correct: 1,
    explain: "Когда свет переходит из воздуха в стекло, его скорость меняется, и луч изгибается (преломление). Форма линзы задаёт, как сильно изгибаются лучи в разных точках. В итоге они могут сходиться в фокусе.",
    tag: "оптика"
  },
  {
    q: "Почему звёзды мерцают, а планеты часто светят ровнее?",
    a: ["Потому что звёзды слабее", "Потому что атмосфера колышется и искажает точечный источник", "Потому что звёзды мигают", "Потому что планеты ближе к Луне"],
    correct: 1,
    explain: "Звезда — почти точка на небе, и атмосферные «волны» постоянно искривляют её свет. Планета видна диском, и искажения усредняются по площади — поэтому мерцание слабее. Это эффект атмосферы, а не самой звезды.",
    tag: "оптика/атмосфера"
  },
  {
    q: "Почему при грозе иногда «пахнет озоном»?",
    a: ["Потому что горит трава", "Молния создаёт активные формы кислорода, включая озон", "Это запах дождя", "Потому что воздух холоднее"],
    correct: 1,
    explain: "Высокоэнергетические разряды молнии могут расщеплять молекулы кислорода, а затем они соединяются в O₃ (озон). У озона характерный резкий запах, который иногда ощущается после грозы.",
    tag: "химия/атмосфера"
  },
  {
    q: "Почему в пещерах температура кажется стабильной?",
    a: ["Потому что там нет ветра", "Потому что земля на глубине имеет почти постоянную температуру", "Потому что там всегда влажно", "Потому что камни греют"],
    correct: 1,
    explain: "Сезонные изменения температуры не проникают глубоко в грунт. На глубине температура меняется очень медленно и мало. Поэтому пещеры держат относительно стабильный режим круглый год.",
    tag: "земля/тепло"
  },
  {
    q: "Почему в наушниках с активным шумоподавлением «тише», чем без музыки?",
    a: ["Они просто плотнее", "Они создают противоположный сигнал и гасят шум", "Они выключают микрофоны", "Потому что мозг отвлекается"],
    correct: 1,
    explain: "Шумоподавление использует микрофон: устройство «слушает» внешний шум и генерирует звуковую волну в противофазе. Эти волны частично взаимно уничтожаются (интерференция). Лучше всего работает на низких и стабильных шумовых частотах.",
    tag: "интерференция"
  },
  {
    q: "Почему после дождя воздух иногда кажется «чище»?",
    a: ["Вода добавляет кислород", "Капли дождя осаждают пыль и аэрозоли", "Солнце меняет состав воздуха", "Потому что становится холоднее"],
    correct: 1,
    explain: "Дождь «смывает» взвешенные частицы: пыль, дым, пыльцу. Меньше частиц — меньше раздражителей для дыхания и больше прозрачность воздуха. Поэтому появляется ощущение свежести.",
    tag: "погода"
  },
  {
    q: "Почему зеркало «переворачивает» изображение по горизонтали?",
    a: ["Потому что зеркало крутит мир", "Оно не переворачивает горизонтально — оно меняет направление 'вперёд-назад'", "Потому что так устроен свет", "Потому что глаз так видит"],
    correct: 1,
    explain: "Зеркало отражает лучи так, что меняется ось «вперёд-назад» относительно поверхности. А мозг интерпретирует это как левое-правое, потому что мы мысленно поворачиваемся лицом к себе. Это классическая ловушка восприятия.",
    tag: "логика/оптика"
  },
  {
    q: "Почему иногда лампочка кажется ярче в тумане?",
    a: ["Туман добавляет свет", "Свет рассеивается на каплях и заполняет пространство вокруг", "Глаза начинают видеть лучше", "Туман отражает свет как зеркало"],
    correct: 1,
    explain: "Капли тумана рассеивают свет во все стороны. Поэтому световой источник создаёт видимое «свечение» вокруг себя, и кажется, что света больше. На самом деле он просто распределяется иначе, делая свет заметнее в объёме.",
    tag: "оптика/туман"
  },
  {
    q: "Почему при сильной жаре асфальт кажется мокрым вдали?",
    a: ["Там реально вода", "Это мираж: преломление света в слоях горячего воздуха", "Асфальт потеет", "Глаза устают"],
    correct: 1,
    explain: "Над горячим асфальтом воздух у поверхности теплее и менее плотный, чем выше. Свет изгибается, как в линзе, и к глазам могут приходить лучи от неба, будто отражённые от поверхности. Поэтому кажется, что вдали лужа.",
    tag: "мираж"
  },
  {
    q: "Что произойдёт с шариком в самолёте при взлёте, если он висит на нитке?",
    a: ["Останется строго вертикально", "Отклонится назад", "Отклонится вперёд", "Начнёт вращаться"],
    correct: 2,
    explain: "При ускорении самолёта вперёд инерция «тянет» шарик назад относительно кабины. Но шарик легче воздуха, а воздух внутри самолёта смещается назад и создаёт градиент давления, который выталкивает шарик вперёд. Поэтому он отклоняется вперёд — это известный парадокс.",
    tag: "инерция/давление"
  },
  {
    q: "Почему в закрытой машине на солнце становится очень жарко?",
    a: ["Солнце греет металл", "Стекло пропускает свет, но хуже выпускает инфракрасное тепло (парниковый эффект)", "Воздух там быстрее", "Потому что нет ветра"],
    correct: 1,
    explain: "Солнечный свет проходит через стекло и нагревает салон. Нагретые поверхности излучают тепло в инфракрасном диапазоне, а стекло частично задерживает это излучение. Плюс почти нет обмена воздуха — температура быстро растёт.",
    tag: "тепло/оптика"
  },
  {
    q: "Почему вода в чайнике шумит перед тем, как закипеть?",
    a: ["Потому что вода 'поёт'", "Потому что образуются пузырьки и колебания усиливаются", "Потому что металл звенит", "Потому что электричество шумит"],
    correct: 1,
    explain: "Перед кипением на стенках образуются пузырьки пара. Они то появляются, то схлопываются, создавая вибрации и характерный шум. Когда кипение становится устойчивым, звук меняется — пузырьков становится очень много и процесс стабилизируется.",
    tag: "кипение"
  },
  {
    q: "Почему иногда кажется, что в коридоре 'давит' и неприятно, хотя там ничего нет?",
    a: ["Потому что мало кислорода", "Потому что акустика и отражения создают странный звуковой фон", "Потому что стены магнитные", "Потому что там радиация"],
    correct: 1,
    explain: "Некоторые пространства усиливают низкие частоты или создают стоячие волны. Низкие частоты хуже локализуются и воспринимаются телом как вибрации, вызывая тревожность. Это может выглядеть как «мистика», но причина часто акустическая.",
    tag: "акустика/психология"
  },
  {
    q: "Почему чай остывает быстрее в широкой кружке, чем в узкой (при прочих равных)?",
    a: ["Потому что кружка красивее", "Потому что больше площадь поверхности — быстрее теплообмен", "Потому что ширина влияет на вкус", "Потому что узкая кружка греет"],
    correct: 1,
    explain: "Тепло уходит через поверхность жидкости и через стенки. У широкой кружки больше площадь поверхности контакта с воздухом, а значит, испарение и теплообмен интенсивнее. Поэтому остывание идёт быстрее.",
    tag: "тепло"
  },
  {
    q: "Почему иногда слышно, как 'трещит' мебель ночью?",
    a: ["Призраки", "Материалы расширяются/сжимаются из-за температуры и влажности", "Дом дышит", "Сквозняк ломает дерево"],
    correct: 1,
    explain: "Дерево и другие материалы реагируют на температуру и влажность: меняют размер и напряжение. Ночью температура часто падает, и детали могут слегка сдвигаться — получается треск. Это обычная физика материалов.",
    tag: "материалы"
  },
  {
    q: "Почему при открытии двери в подъезде иногда 'свистит'?",
    a: ["Потому что дверь поёт", "Потому что воздух проходит через щель и образует вихри (аэродинамический свист)", "Потому что металл вибрирует", "Потому что слышно эхо"],
    correct: 1,
    explain: "Когда воздух с заметной скоростью проходит через узкую щель, возникают вихри. Они могут колебаться на устойчивой частоте и создавать слышимый тон. Это как мини-свисток, только в дверной щели.",
    tag: "аэродинамика/звук"
  },
  {
    q: "Почему иногда кажется, что в темноте предметы движутся?",
    a: ["Потому что они двигаются", "Из-за микродвижений глаз и нехватки ориентиров", "Из-за магнитных полей", "Потому что воздух толкает вещи"],
    correct: 1,
    explain: "Глаза постоянно делают микродвижения (микросаккады). В темноте ориентиров мало, мозгу сложнее стабилизировать картину, и тени/контуры могут 'плыть'. Это нормальная особенность восприятия, усиливающая тревожность.",
    tag: "восприятие"
  }
];

// ВАЖНО: quizBank должен быть объявлен выше (ты уже сделала)

// =====================
// ВИКТОРИНА: СОСТОЯНИЕ
// =====================
let quizState = null;

function shuffle(arr){
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function pickQuestions(count = 7){
  return shuffle(quizBank).slice(0, count);
}

function shuffleAnswers(qObj){
  const indexed = qObj.a.map((text, idx) => ({ text, idx }));
  const mixed = shuffle(indexed);
  const newCorrect = mixed.findIndex(x => x.idx === qObj.correct);
  return { ...qObj, a: mixed.map(x => x.text), correct: newCorrect };
}

function startQuiz({
  sceneId = "sceneQuiz",
  containerId = "quizBox",
  count = 7,
  passNeed = 5,
  onPass = () => go("scene1"),
} = {}){
  if (!Array.isArray(quizBank) || quizBank.length < 5){
    const box = document.getElementById(containerId);
    if (box) box.innerHTML = `<p class="bad">Банк вопросов пуст или не найден.</p>`;
    go(sceneId);
    return;
  }

  const raw = pickQuestions(count).map(shuffleAnswers);

  quizState = {
    i: 0,
    right: 0,
    passNeed,
    questions: raw,
    onPass,
    sceneId,
    containerId
  };

  go(sceneId);
  renderQuiz();
}

function renderQuiz(){
  if (!quizState) return;
  const box = document.getElementById(quizState.containerId);
  if (!box) return;

  const qObj = quizState.questions[quizState.i];
  const progress = `Вопрос ${quizState.i + 1}/${quizState.questions.length} • Верных: ${quizState.right}/${quizState.passNeed}`;

  box.innerHTML = `
    <div class="quizTop">
      <div class="small">${progress}</div>
      <div class="quizQ">${qObj.q}</div>
    </div>

    <div class="quizAnswers">
      ${qObj.a.map((t, idx) => `
        <button type="button" class="quizBtn" data-ans="${idx}">${t}</button>
      `).join("")}
    </div>

    <div id="quizExplain" class="quizExplain" style="display:none;"></div>

    <div class="quizBottom">
      <button type="button" id="quizNext" style="display:none;">Дальше →</button>
    </div>
  `;

  box.querySelectorAll(".quizBtn").forEach(btn => {
    btn.addEventListener("click", () => chooseAnswer(Number(btn.dataset.ans)));
  });
}

function chooseAnswer(ansIdx){
  const qObj = quizState.questions[quizState.i];
  const ok = ansIdx === qObj.correct;

  const box = document.getElementById(quizState.containerId);
  if (!box) return;

  box.querySelectorAll(".quizBtn").forEach(b => b.disabled = true);

  box.querySelectorAll(".quizBtn").forEach((b, idx) => {
    if (idx === qObj.correct) b.classList.add("good");
    if (idx === ansIdx && !ok) b.classList.add("bad");
  });

  if (ok) quizState.right++;

  const explain = document.getElementById("quizExplain");
  explain.style.display = "block";
  explain.innerHTML = `
    <div class="${ok ? "ok" : "bad"}" style="font-weight:700; margin-bottom:6px;">
      ${ok ? "✅ Верно" : "❌ Неверно"}
    </div>
    <div class="small">${qObj.explain}</div>
  `;

  const next = document.getElementById("quizNext");
  next.style.display = "inline-block";
  next.onclick = () => nextQuestion();
}

function nextQuestion(){
  quizState.i++;

  if (quizState.i >= quizState.questions.length){
    finishQuiz();
    return;
  }
  renderQuiz();
}

function finishQuiz(){
  const box = document.getElementById(quizState.containerId);
  if (!box) return;

  const passed = quizState.right >= quizState.passNeed;

  box.innerHTML = `
    <div class="quizTop">
      <div class="quizQ">${passed ? "Дверь поддалась…" : "Дом не принял ответы."}</div>
      <p class="small">
        Верных ответов: <b>${quizState.right}</b> из <b>${quizState.questions.length}</b>.
        Нужно минимум: <b>${quizState.passNeed}</b>.
      </p>
      <p class="small">
        ${passed
          ? "Петля замка щёлкает, и воздух будто становится тише."
          : "Гул усиливается на секунду. Словно ты нажал не на те кнопки мира."}
      </p>
    </div>

    <div class="quizBottom">
      ${passed
        ? `<button type="button" id="quizGo">Открыть дверь →</button>`
        : `<button type="button" id="quizRetry">Попробовать снова</button>`}
      <button type="button" onclick="go('scene1')">← Назад к дверям</button>
    </div>
  `;

  if (passed){
    box.querySelector("#quizGo").onclick = () => quizState.onPass();
  } else {
    box.querySelector("#quizRetry").onclick = () => startQuiz({
      sceneId: quizState.sceneId,
      containerId: quizState.containerId,
      count: quizState.questions.length,
      passNeed: quizState.passNeed,
      onPass: quizState.onPass
    });
  }
}
